# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: Copyright contributors to the vLLM project
# ruff: noqa: E501

import csv
from pathlib import Path

import pytest

from vllm.entrypoints.openai import speech_to_text


def _load_voxtral_tokens_for_ids(token_ids: list[int]) -> dict[int, str]:
    """Load token strings for the given IDs from the Voxtral vocab CSV.

    This is intentionally lazy: it scans the CSV once and only collects the
    requested IDs.
    """
    repo_root = Path(__file__).resolve().parents[2]
    csv_path = repo_root / "vllm-debug" / "models" / "vllm_tokenizer_vocab_voxtral.csv"
    if not csv_path.exists():
        pytest.skip(f"Missing vocab CSV: {csv_path}")

    want = set(int(t) for t in token_ids)
    found: dict[int, str] = {}
    with csv_path.open("r", encoding="utf-8", newline="") as f:
        reader = csv.DictReader(f)
        for row in reader:
            try:
                idx = int(row["id"])
            except Exception:
                continue
            if idx in want:
                found[idx] = row.get("token", "")
                if len(found) == len(want):
                    break

    missing = sorted(want - set(found))
    if missing:
        pytest.fail(
            f"Missing {len(missing)} token ids from vocab CSV, e.g. {missing[:20]}"
        )
    return found


TEST_CASES = [
    {
        "name": "voxtral_log_example_1",
        # This reproduces the problematic Voxtral token stream observed in logs.
        "token_ids": [
            1060,
            1048,
            1048,
            1058,
            1048,
            1048,
            1046,
            1048,
            1062,
            1531,
            43143,
            2342,
            1032,
            1051,
            14082,
            1885,
            1048,
            1048,
            1058,
            1048,
            1049,
            1046,
            1053,
            1561,
            1060,
            1048,
            1048,
            1058,
            1048,
            1049,
            1046,
            1053,
            1062,
            9032,
            1044,
            1455,
            1395,
            5782,
            2156,
            1722,
            2081,
            70777,
            1294,
            50348,
            2224,
            2156,
            1584,
            43143,
            15342,
            1048,
            1048,
            1058,
            1048,
            1054,
            1046,
            1055,
            1561,
            1060,
            1048,
            1048,
            1058,
            1048,
            1054,
            1046,
            1056,
        ],
        "start_time": 0.0,
        "expected": [
            {
                "start": 0.0,
                "end": 1.5,
                "text": " The whites only 3%.",
            },
            {
                "start": 1.5,
                "end": 6.7,
                "text": " Now, that is why there were more blacks in jail than there are whites.",
            },
        ],
    },
    {
        "name": "voxtral_log_example_2",
        # this case is starting correctly with "<"
        "token_ids": [
            1060,
            1048,
            1048,
            1058,
            1048,
            1048,
            1046,
            1048,
            1062,
            1531,
            43143,
            2342,
            1032,
            1051,
            14082,
            1885,
            1048,
            1048,
            1058,
            1048,
            1049,
            1046,
            1053,
            1561,
            1060,
            1048,
            1048,
            1058,
            1048,
            1049,
            1046,
            1053,
            1062,
            9032,
            1044,
            1455,
            1395,
            5782,
            2156,
            1722,
            2081,
            70777,
            1294,
            50348,
            2224,
            2156,
            1584,
            43143,
            15342,
            1048,
            1048,
            1058,
            1048,
            1054,
            1046,
            1055,
            1561,
            1060,
            1048,
            1048,
            1058,
            1048,
            1054,
            1046,
            1056,
            1062,
            5646,
            1681,
            21613,
            15342,
            1048,
            1048,
            1058,
            1048,
            1055,
            1046,
            1052,
            1561,
            1060,
            1048,
            1048,
            1058,
            1048,
            1055,
            1046,
            1055,
            1062,
            3060,
            3246,
            2878,
            1639,
            2586,
            14776,
            3226,
            1321,
            2430,
            1974,
            1044,
            1747,
            3169,
            89458,
            1048,
            1048,
            1058,
            1049,
            1048,
            1046,
            1049,
            1561,
            1060,
            1048,
            1048,
            1058,
            1049,
            1048,
            1046,
            1050,
            1062,
            4493,
            1729,
            2985,
            1513,
            1455,
            59234,
            15342,
            1048,
            1048,
            1058,
            1049,
            1049,
            1046,
            1054,
            1561,
            1060,
            1048,
            1048,
            1058,
            1049,
            1050,
            1046,
            1048,
            1062,
            3797,
            3169,
            15342,
            1048,
            1048,
            1058,
            1049,
            1050,
            1046,
            1051,
            1561,
            1060,
            1048,
            1048,
            1058,
            1049,
            1050,
            1046,
            1051,
            1062,
            4159,
            3884,
            1494,
            3879,
            15342,
            1048,
            1048,
            1058,
            1049,
            1051,
            1046,
            1054,
            1561,
            1060,
            1048,
            1048,
            1058,
            1049,
            1052,
            1046,
            1048,
            1062,
            3213,
            2840,
            1044,
            1278,
            27383,
            2292,
            23168,
            2403,
            1848,
            2156,
            3884,
            1494,
            3879,
            1455,
            1278,
            70777,
            1584,
            3144,
            20431,
            1408,
            15342,
            1048,
            1048,
            1058,
            1049,
            1056,
            1046,
            1051,
            1561,
            1060,
            1048,
            1048,
            1058,
            1049,
            1056,
            1046,
            1051,
            1062,
            4414,
            1890,
            1044,
            2606,
            1584,
            1636,
            3637,
            1408,
            6168,
            8281,
            1321,
            2586,
            2639,
            1455,
            7244,
            3306,
            1584,
            49230,
            1317,
            18886,
            1532,
            89458,
            1048,
            1048,
            1058,
            1050,
            1049,
            1046,
            1056,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1049,
            1046,
            1057,
            1062,
            1362,
            12285,
            2405,
            1402,
            5083,
            1317,
            9148,
            1317,
            1455,
            15342,
            1048,
            1048,
            1058,
            1050,
            1050,
            1046,
            1056,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1050,
            1046,
            1057,
            1062,
            18818,
            1044,
            2127,
            1584,
            15342,
            1048,
            1048,
            1058,
            1050,
            1051,
            1046,
            1054,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1052,
            1046,
            1049,
            1062,
            3626,
            1636,
            3648,
            7244,
            3306,
            1584,
            49230,
            1317,
            18886,
            1532,
            89458,
            1048,
            1048,
            1058,
            1050,
            1053,
            1046,
            1056,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1053,
            1046,
            1057,
            1062,
            1531,
            21767,
            3226,
            1294,
            1278,
            2629,
            15342,
            1048,
            1048,
            1058,
            1050,
            1055,
            1046,
            1050,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1055,
            1046,
            1052,
            1062,
            3213,
            2607,
            2405,
            4204,
            1317,
            4150,
            1455,
            15342,
            1048,
            1048,
            1058,
            1050,
            1056,
            1046,
            1050,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1056,
            1046,
            1050,
            1062,
            1362,
            4525,
            4670,
            1317,
            5628,
            1636,
            1261,
            11611,
            1317,
            6298,
            1639,
            15342,
            1048,
            1048,
            1058,
            1050,
            1057,
            1046,
            1049,
            1561,
            1060,
            1048,
            1048,
            1058,
            1050,
            1057,
            1046,
            1051,
            1062,
            3213,
            2607,
            2405,
            4204,
            1455,
            7244,
            3306,
            1584,
            49230,
            1317,
            18886,
            1532,
            15342,
            1048,
            1048,
            1058,
            1051,
            1049,
            1046,
            1051,
            1561,
            1060,
            1048,
            1048,
            1058,
            1051,
            1049,
            1046,
            1052,
            1062,
            5675,
            1395,
            1593,
            11051,
            89458,
            1048,
            1048,
            1058,
            1051,
            1050,
            1046,
            1050,
            1561,
            1060,
            1048,
            1048,
            1058,
            1051,
            1050,
            1046,
            1053,
            1062,
            1362,
            2607,
            2405,
            2840,
            2549,
            1455,
            8223,
            1044,
            1809,
            1362,
            2840,
            15342,
            1048,
            1048,
            1058,
            1051,
            1051,
            1046,
            1056,
            1062,
        ],
        # ['<', '0', '0', ':', '0', '0', '.', '0', '>', ' The', ' whites', ' only', ' ', '3', '%.', '</', '0', '0', ':', '0', '1', '.', '5', '>\n', '<', '0', '0', ':', '0', '1', '.', '5', '>', ' Now', ',', ' that', ' is', ' why', ' there', ' were', ' more', ' blacks', ' in', ' jail', ' than', ' there', ' are', ' whites', '.</', '0', '0', ':', '0', '6', '.', '7', '>\n', '<', '0', '0', ':', '0', '6', '.', '8', '>', ' That', "'s", ' okay', '.</', '0', '0', ':', '0', '7', '.', '4', '>\n', '<', '0', '0', ':', '0', '7', '.', '7', '>', ' And', ' now', ' let', ' me', ' just', ' finish', ' here', ' and', ' then', ' go', ',', ' all', ' right', '?</', '0', '0', ':', '1', '0', '.', '1', '>\n', '<', '0', '0', ':', '1', '0', '.', '2', '>', ' So', ' we', ' look', ' at', ' that', ' statistic', '.</', '0', '0', ':', '1', '1', '.', '6', '>\n', '<', '0', '0', ':', '1', '2', '.', '0', '>', ' All', ' right', '.</', '0', '0', ':', '1', '2', '.', '3', '>\n', '<', '0', '0', ':', '1', '2', '.', '3', '>', ' They', ' turn', ' it', ' around', '.</', '0', '0', ':', '1', '3', '.', '6', '>\n', '<', '0', '0', ':', '1', '4', '.', '0', '>', ' You', ' know', ',', ' the', ' racial', ' dem', 'agog', 'ues', ' out', ' there', ' turn', ' it', ' around', ' that', ' the', ' blacks', ' are', ' being', ' picked', ' on', '.</', '0', '0', ':', '1', '8', '.', '3', '>\n', '<', '0', '0', ':', '1', '8', '.', '3', '>', ' Gu', 'ys', ',', ' how', ' are', ' you', ' still', ' on', ' national', ' TV', ' and', ' just', ' said', ' that', ' black', ' people', ' are', ' prone', ' to', ' criminal', 'ity', '?</', '0', '0', ':', '2', '1', '.', '8', '>\n', '<', '0', '0', ':', '2', '1', '.', '9', '>', ' I', ' wouldn', "'t", ' be', ' able', ' to', ' respond', ' to', ' that', '.</', '0', '0', ':', '2', '2', '.', '8', '>\n', '<', '0', '0', ':', '2', '2', '.', '9', '>', ' Well', ',', ' they', ' are', '.</', '0', '0', ':', '2', '3', '.', '6', '>\n', '<', '0', '0', ':', '2', '4', '.', '1', '>', ' But', ' you', ' think', ' black', ' people', ' are', ' prone', ' to', ' criminal', 'ity', '?</', '0', '0', ':', '2', '5', '.', '8', '>\n', '<', '0', '0', ':', '2', '5', '.', '9', '>', ' The', ' statistics', ' here', ' in', ' the', ' show', '.</', '0', '0', ':', '2', '7', '.', '2', '>\n', '<', '0', '0', ':', '2', '7', '.', '4', '>', ' You', ' don', "'t", ' mean', ' to', ' say', ' that', '.</', '0', '0', ':', '2', '8', '.', '2', '>\n', '<', '0', '0', ':', '2', '8', '.', '2', '>', ' I', "'m", ' going', ' to', ' give', ' you', ' a', ' chance', ' to', ' correct', ' me', '.</', '0', '0', ':', '2', '9', '.', '1', '>\n', '<', '0', '0', ':', '2', '9', '.', '3', '>', ' You', ' don', "'t", ' mean', ' that', ' black', ' people', ' are', ' prone', ' to', ' criminal', 'ity', '.</', '0', '0', ':', '3', '1', '.', '3', '>\n', '<', '0', '0', ':', '3', '1', '.', '4', '>', ' What', ' is', ' this', ' saying', '?</', '0', '0', ':', '3', '2', '.', '2', '>\n', '<', '0', '0', ':', '3', '2', '.', '5', '>', ' I', ' don', "'t", ' know', ' what', ' that', ' says', ',', ' but', ' I', ' know', '.</', '0', '0', ':', '3', '3', '.', '8', '>'],
        "start_time": 0.0,
        "expected": [
            {
                "start": 0.0,
                "end": 1.5,
                "text": " The whites only 3%.",
            },
            {
                "start": 1.5,
                "end": 6.7,
                "text": " Now, that is why there were more blacks in jail than there are whites.",
            },
            {
                "start": 6.8,
                "end": 7.4,
                "text": " That's okay.",
            },
            {
                "start": 7.7,
                "end": 10.1,
                "text": " And now let me just finish here and then go, all right?",
            },
            {
                "start": 10.2,
                "end": 11.6,
                "text": " So we look at that statistic.",
            },
            {
                "start": 12.0,
                "end": 12.3,
                "text": " All right.",
            },
            {
                "start": 12.3,
                "end": 13.6,
                "text": " They turn it around.",
            },
            {
                "start": 14.0,
                "end": 18.3,
                "text": " You know, the racial demagogues out there turn it around that the blacks are being picked on.",
            },
            {
                "start": 18.3,
                "end": 21.8,
                "text": " Guys, how are you still on national TV and just said that black people are prone to criminality?",
            },
            {
                "start": 21.9,
                "end": 22.8,
                "text": " I wouldn't be able to respond to that.",
            },
            {
                "start": 22.9,
                "end": 23.6,
                "text": " Well, they are.",
            },
            {
                "start": 24.1,
                "end": 25.8,
                "text": " But you think black people are prone to criminality?",
            },
            {
                "start": 25.9,
                "end": 27.2,
                "text": " The statistics here in the show.",
            },
            {
                "start": 27.4,
                "end": 28.2,
                "text": " You don't mean to say that.",
            },
            {
                "start": 28.2,
                "end": 29.1,
                "text": " I'm going to give you a chance to correct me.",
            },
            {
                "start": 29.3,
                "end": 31.3,
                "text": " You don't mean that black people are prone to criminality.",
            },
            {
                "start": 31.4,
                "end": 32.2,
                "text": " What is this saying?",
            },
            {
                "start": 32.5,
                "end": 33.8,
                "text": " I don't know what that says, but I know.",
            },
        ],
    },
]


@pytest.mark.parametrize("case", TEST_CASES, ids=[c["name"] for c in TEST_CASES])
def test_parse_verbose_json_voxtral(case):
    token_ids = case["token_ids"]
    id_to_tok = _load_voxtral_tokens_for_ids(token_ids)
    token_strs = [id_to_tok[i] for i in token_ids]
    start_time = float(case.get("start_time", 0.0))

    spans = speech_to_text._parse_verbose_json_voxtral(
        token_ids,
        token_strs=token_strs,
        start_time=start_time,
    )

    expected = case["expected"]
    assert len(spans) == len(expected)
    for (seg_start, seg_end, seg_text, seg_token_ids), exp in zip(spans, expected):
        assert seg_start == pytest.approx(exp["start"])
        assert seg_end == pytest.approx(exp["end"])
        assert seg_text == exp["text"]
        assert isinstance(seg_token_ids, list)
